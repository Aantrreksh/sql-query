<!DOCTYPE html
  PUBLIC "XSLT-compat" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
   
   <head>
      
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
      
      <meta name="security" content="public"></meta>
      
      <meta name="Robots" content="index,follow"></meta>
      
      <meta name="DC.Type" content="reference"></meta>
      
      <meta name="DC.Title" content="Executing a spatial query in Spark"></meta>
      
      <meta name="abstract" content="This topic contains examples that illustrate the most commonly used spatial functions."></meta>
      
      <meta name="Description" content="This topic contains examples that illustrate the most commonly used spatial functions."></meta>
      
      <meta name="copyright" content="© Copyright IBM Corporation 2017"></meta>
      
      <meta name="DC.Rights.Owner" content="© Copyright IBM Corporation 2017"></meta>
      
      <meta name="DC.Date" scheme="iso8601" content="2018-06-27"></meta>
      
      <meta name="DC.Format" content="XHTML"></meta>
      
      <meta name="DC.Identifier" content="geo_common"></meta>
      
      <meta name="DC.Language" content="en-us"></meta>
      
      <meta name="IBM.Country" content="ZZ"></meta>
      
      <!-- Licensed Materials - Property of IBM -->
      
      <!-- US Government Users Restricted Rights -->
      
      <!-- Use, duplication or disclosure restricted by -->
      
      <!-- GSA ADP Schedule Contract with IBM Corp. -->
      
      <link rel="stylesheet" type="text/css" href="../ibmdita.css"></link>
      
      <link rel="stylesheet" type="text/css" href="../swg_info_common.css"></link>
      
      <title>Executing a spatial query in Spark</title>
      
   </head>
   
   <body id="geo_common">
      <div role="main">
         
         <h1 class="title topictitle1">Executing a spatial query in Spark</h1>
         
         <div class="body refbody">
            <p class="shortdesc">This topic contains examples that illustrate the most commonly used spatial
               functions.
            </p>
            
            <div class="section">
               <div class="p">Common types of spatial queries are:
                  <ul class="ul">
                     <li class="li">In a set of points, find all points that are withing a certain distance of a particular point.
                        For example, find all hospitals that are within a certain distance of a particular location.
                     </li>
                     
                     <li class="li">In a set of polygons, find all polygons that contain a particular point. For example, find all
                        risk areas (fire, flood, hurricane, etc.) that contain a particular location.
                     </li>
                     
                     <li class="li">In a set of points, find all points that are contained within a particular polygon. For example,
                        find all retail outlets in a particular region.
                     </li>
                     
                  </ul>
                  
               </div>
               
               
               <p class="p">Often, a spatial function has one parameter that refers to a spatial column in one table and a
                  second parameter that refers to a spatial constant or to a spatial column in another table.
               </p>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Determine which points are close to another point</h2>
               
               <div class="p">A simple example is to find the hospitals that are within a certain distance of a given location
                  (which is constructed using the <samp class="ph codeph">ST_Point</samp>
                  constructor).<pre class="pre codeblock"><code>// register the data frame  as a table
hospitalsDf.createOrReplaceTempView("hospitals")</code></pre>
                  The
                  following query returns a list of the hospitals within 10 km of Grand Central Station in
                  NYC.<pre class="pre codeblock"><code>SELECT name, city, state
FROM hospitals
WHERE ST_Distance(location, ST_Point(-77.574722, 43.146732)) &lt; 10000.0</code></pre>
                  </div>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Determine which polygon contains a point</h2>
               
               <div class="p">Examples of spatial functions that determine which polygon contains a point are:
                  <ol class="ol">
                     <li class="li"><samp class="ph codeph">ST_Contains(geom1, geom2)</samp> -- returns <samp class="ph codeph">TRUE</samp> if
                        <samp class="ph codeph">geom2</samp> values are completely contained by the polygons identified by
                        <samp class="ph codeph">geom1</samp>.
                     </li>
                     
                     <li class="li"><samp class="ph codeph">ST_Within(geom1, geom2)</samp> -- returns <samp class="ph codeph">TRUE</samp> if
                        <samp class="ph codeph">geom1</samp> values are within the polygons identified by <samp class="ph codeph">geom2</samp>.
                     </li>
                     
                     <li class="li"><samp class="ph codeph">ST_Intersects(geom1, geom2)</samp> -- returns <samp class="ph codeph">TRUE</samp> if
                        <samp class="ph codeph">geom1</samp> and <samp class="ph codeph">geom2</samp> intersect spatially in any way, touching,
                        crossing, or containing each other
                     </li>
                     
                  </ol>
                  
               </div>
               
               
               <div class="p">Each of the following queries uses one of these functions, and returns the name of the county
                  that contains the specified
                  point:<pre class="pre codeblock"><code>SELECT NAME 
FROM counties 
WHERE 
ST_Contains(shape, ST_Point(-74.237, 42.037))

SELECT NAME
FROM counties
WHERE
ST_Within(ST_Point(-74.237, 42.037), shape)

SELECT NAME
FROM counties
WHERE
ST_Intersects(shape, ST_Point(-74.237, 42.037))</code></pre>
                  </div>
               
               
               <p class="p">Each query returns the answer <strong class="ph b">Ulster</strong>.
               </p>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Determine which points are in a polygon</h2>
               
               <p class="p">Each of the following queries determines which hospitals are located within the specified
                  polygon, which is defined as a constant using well-known text (WKT) representation. The polygon
                  definition consists of the character string <samp class="ph codeph">POLYGON</samp> followed by a pair of
                  <em class="ph i">x,y</em> coordinates for each vertex, separated by a comma. The individual <samp class="ph codeph">x</samp> and
                  <samp class="ph codeph">y</samp> values are separated by a space. The entire list of coordinate pairs must be in
                  parentheses.
               </p>
               
               
               <div class="p"><pre class="pre codeblock"><code>SELECT name
FROM hospitals
WHERE
ST_Contains(ST_WKTToSQL('POLYGON ((-74.0 42.0, -73.0 42.0, -73.0 43.0, -74.0 43.0, -74.0 42.0))'), location)

SELECT name 
FROM hospitals 
WHERE ST_Within(location, ST_WKTToSQL('POLYGON ((-74.0 42.0, -73.0 42.0, -73.0 43.0, -74.0 43.0, -74.0 42.0))'))

SELECT name 
FROM hospitals 
WHERE ST_Intersects(location, ST_WKTToSQL('POLYGON ((-74.0 42.0, -73.0 42.0, -73.0 43.0, -74.0 43.0, -74.0 42.0))'))</code></pre>
                  </div>
               
               
               <div class="p">Each query returns a list of 21 hospitals. The first five hospitals are:
                  <ol class="ol">
                     <li class="li">Marshall Hospital</li>
                     
                     <li class="li">Southwestern Medical Center</li>
                     
                     <li class="li">Hillcrest Hospital</li>
                     
                     <li class="li">Saint Lukes Hospital</li>
                     
                     <li class="li">Adventist Home</li>
                     
                  </ol>
                  
               </div>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Determine which points are in a polygon using a spatial join</h2>
               
               <p class="p">Just as a regular join function can join two tables based on the values in columns that contain
                  character or numeric data, spatial join functions can be used to join tables based on the values in
                  columns that contain spatial data. The following examples use the <strong class="ph b">counties</strong> and
                  <strong class="ph b">hospitals</strong> tables.
               </p>
               
               
               <div class="p">You can use the spatial join function to find the hospitals located within a specific county. For
                  example, the following query returns a list of all the hospitals in Dutchess
                  county:<pre class="pre codeblock"><code>SELECT c.NAME, h.name 
FROM counties AS c, hospitals AS h 
WHERE c.NAME = 'Dutchess' 
AND ST_Intersects(c.shape, h.location)</code></pre>
                  This
                  query produces the following result set:<div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_xsd_njg_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e161">Hospital Name</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e163">County Name</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">Hudson River State Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">Vassar Brothers Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">Bowne Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">Harlem Valley State Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">Matteawan State Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">New York State Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">Saint Francis Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e161 ">United States Veterans Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e163 ">Dutchess</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  
               </div>
               
               
               <div class="p">Alternatively, you can use the <samp class="ph codeph">SQL JOIN ... ON</samp> notation, which is equivalent to
                  a spatial predicate in the <samp class="ph codeph">WHERE</samp> clause. For example, the following query produces
                  the same result set as the previous
                  query:<pre class="pre codeblock"><code>SELECT h.name, c.NAME
FROM counties AS c
JOIN hospitals AS h
ON c.NAME = 'Dutchess'
AND ST_Intersects(h.location, c.shape)</code></pre>
                  </div>
               
               
               <div class="p">The following query returns the name of the county in which a particular hospital is
                  located:<pre class="pre codeblock"><code>SELECT c.NAME, h.name
FROM hospitals AS h, counties AS c
WHERE ST_Intersects(h.location, c.shape)
AND h.name = 'Vassar Brothers Hospital'</code></pre>
                  This
                  query produces the following result
                  set:<pre class="pre codeblock"><code>"Vassar Brothers Hospital", "Dutchess"</code></pre>
                  </div>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Additional predicates and aggregation</h2>
               
               <p class="p">This example that uses spatial joins in conjunction with additional predicates and aggregation,
                  which can address business problems. These examples continue to use the hospitals and counties
                  tables, but the same principles can be applied to any type of data.
               </p>
               
               
               <div class="p">This example queries the hospitals within each county in New York state, qualifying by the state
                  name in the counties
                  table.<pre class="pre codeblock"><code>SELECT c.NAME, h.name
FROM counties AS c, hospitals AS h
WHERE ST_Intersects(h.location, c.shape)
AND c.STATE_NAME='New York'
ORDER BY c.NAME, h.name</code></pre>
                  The
                  result shows the first five of the 230 hospitals in New York.<div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_z5j_tjg_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e243">Hospital Name</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e245">County Name</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e243 ">Albany Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e245 ">Albany</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e243 ">Albany Hospital for Incurables</td>
                              
                              <td class="entry" valign="top" headers="d18049e245 ">Albany</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e243 ">Albany Hospital Sanatorium</td>
                              
                              <td class="entry" valign="top" headers="d18049e245 ">Albany</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e243 ">Cohoes Memorial Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e245 ">Albany</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e243 ">Saint Peters Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e245 ">Albany</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  The same results can be obtained by rewriting the above query with using the field from
                  hospitals
                  table:<pre class="pre codeblock"><code>SELECT c.NAME, h.name
FROM hospitals AS h, counties AS c
WHERE ST_Intersects(h.location, c.shape)
AND h.state='NY'
ORDER BY c.NAME, h.name</code></pre>
                  The
                  following example summarizes the number of hospitals per county in New
                  York.<pre class="pre codeblock"><code>SELECT c.NAME, COUNT(h.name) AS hospital_count
FROM counties AS c, hospitals AS h
WHERE ST_Intersects(h.location, c.shape)
AND c.STATE_NAME='New York'
GROUP BY c.NAME</code></pre>
                  This
                  generates a total of 45 results with the first five results (order may not be as shown below always)
                  shown in the below table.<div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_dmn_wjg_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e286">County_name</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e288">Hospital_count</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e286 ">Essex</td>
                              
                              <td class="entry" valign="top" headers="d18049e288 ">3</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e286 ">Livingston</td>
                              
                              <td class="entry" valign="top" headers="d18049e288 ">1</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e286 ">Orange</td>
                              
                              <td class="entry" valign="top" headers="d18049e288 ">4</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e286 ">Herkimer</td>
                              
                              <td class="entry" valign="top" headers="d18049e288 ">1</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e286 ">Queens</td>
                              
                              <td class="entry" valign="top" headers="d18049e288 ">19</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  To identify counties where the population is underserved by hospitals, an interesting metric
                  might be the number of people per hospital in each county. Using the population for each county in
                  the year 2000, you can calculate this
                  number.<pre class="pre codeblock"><code>SELECT c.NAME, 
COUNT(h.name) AS hospital_count, 
c.POP2000 AS Population, 
c.POP2000/COUNT(h.name) AS people_per_hospital
FROM counties AS c, hospitals AS h
WHERE c.STATE_NAME='New York'
AND ST_Intersects(h.location, c.shape)
GROUP BY c.NAME, c.POP2000
ORDER BY people_per_hospital DESC</code></pre>
                  The
                  results of this (a total of 45 records) are shown for the first five.<div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_r52_1kg_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e329">County_name</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e331">Hospital_Count</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e333">Population</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e335">People_per_hospital</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e329 ">Bronx</td>
                              
                              <td class="entry" valign="top" headers="d18049e331 ">9</td>
                              
                              <td class="entry" valign="top" headers="d18049e333 ">1332650</td>
                              
                              <td class="entry" valign="top" headers="d18049e335 ">148072</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e329 ">Chautauqua</td>
                              
                              <td class="entry" valign="top" headers="d18049e331 ">1</td>
                              
                              <td class="entry" valign="top" headers="d18049e333 ">139750</td>
                              
                              <td class="entry" valign="top" headers="d18049e335 ">139750.0</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e329 ">Oswego</td>
                              
                              <td class="entry" valign="top" headers="d18049e331 ">1</td>
                              
                              <td class="entry" valign="top" headers="d18049e333 ">122377</td>
                              
                              <td class="entry" valign="top" headers="d18049e335 ">122377.0</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e329 ">Nassau</td>
                              
                              <td class="entry" valign="top" headers="d18049e331 ">11</td>
                              
                              <td class="entry" valign="top" headers="d18049e333 ">1334544</td>
                              
                              <td class="entry" valign="top" headers="d18049e335 ">121322</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e329 ">Queens</td>
                              
                              <td class="entry" valign="top" headers="d18049e331 ">19</td>
                              
                              <td class="entry" valign="top" headers="d18049e333 ">2229379</td>
                              
                              <td class="entry" valign="top" headers="d18049e335 ">117335</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  If one had additional details such as number of beds, number of doctors per hospital, one
                  can determine a better measure of health care capability.
               </div>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Window queries</h2>
               
               <div class="p">A common use case for mapping applications and in particular for web mapping is to select objects
                  that fall within a rectangular region. This can be done by creating a polygon to represent the
                  rectangle and the <samp class="ph codeph">ST_Intersects</samp> spatial
                  predicate.<pre class="pre codeblock"><code>SELECT name
FROM hospitals
WHERE ST_Intersects(location, ST_WKTToSQL(
 'POLYGON ((-74.0 42.0, -73.0 42.0, -73.0 43.0, -74.0 43.0, -74.0 42.0))'))</code></pre>
                  </div>
               
               
               <div class="p">Another spatial predicate that does the same is <samp class="ph codeph">EnvelopesIntersect</samp>, which can be
                  used to select objects whose envelope intersects a rectangular region.
                  <samp class="ph codeph">EnvelopesIntersect</samp> takes as a parameter the name of the spatial column, four
                  <samp class="ph codeph">Double</samp> values representing the lower-left, and upper-right corners of the
                  rectangle. This spatial predicate is simpler to use and is more efficient than
                  <samp class="ph codeph">ST_Intersects</samp> for rectangular
                  windows.<pre class="pre codeblock"><code>SELECT name
FROM hospitals
WHERE EnvelopesIntersect(location, -74.0, 42.0, -73.0, 43.0)</code></pre>
                  </div>
               
               
               <p class="p">Because this predicate is true if any portion of a line or polygon geometry falls within the
                  specified window, parts of the line or polygon might lie outside of the window. This is generally
                  not a problem with mapping applications, which will discard geometries that lie outside the display
                  window.
               </p>
               
               
               <div class="p">When building web-mapping applications with widely used web-mapping APIs from providers such as
                  Google Maps, Yahoo! Maps, Bing Maps, and others, it is necessary to provide the longitude and
                  latitude values to be used in placing custom markers on the map. Obtain this information with a
                  query such as this
                  one:<pre class="pre codeblock"><code>SELECT name, ST_X(location) AS longitude, ST_Y(location) AS latitude
FROM hospitals
WHERE EnvelopesIntersect(location, -74.0, 42.0, -73.0, 43.0)</code></pre>
                  </div>
               
            </div>
            
            <div class="section">
               <h2 class="title sectiontitle">Distance queries</h2>
               
               <div class="p">Another common type of spatial query is to find things within a specified distance of a
                  particular location. You have probably used web mapping applications to get this kind of
                  information. You can issue SQL queries from your application for queries like:
                  <ul class="ul">
                     <li class="li">Finding customers within 10 miles of a store</li>
                     
                     <li class="li">Finding ATMs within 500 meters of the current location</li>
                     
                     <li class="li">Finding competitive stores within 10 kilometers of a proposed store location</li>
                     
                  </ul>
                  The primary spatial function here is <samp class="ph codeph">ST_Distance</samp>, which computes the distance
                  between spatial values and returns a result in meters. The following query generates eight
                  results:<pre class="pre codeblock"><code>SELECT name
FROM hospitals
WHERE ST_Distance(location, ST_Point(-74.237, 42.037)) &lt; 46800
ORDER BY name</code></pre>
                  </div>
               
               
               <div class="p"><strong class="ph b">Results</strong><div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_bcz_4wh_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e448">Name</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Adventist Home</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Bowne Hospital</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Columbia Memorial Hospital</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Firemens Home</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Greene County Memorial Hospital</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Hudson River State Hospital</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Saint Francis Hospital</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e448 ">Vassar Brothers Hospital</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  A different way of querying the same as above is to use the <samp class="ph codeph">ST_Buffer</samp>,
                  where a circular buffer is created around the given geometry and the desired geometries within that
                  buffer are determined. The <samp class="ph codeph">ST_Buffer</samp> function takes as parameters a spatial
                  geometry and a distance in meters to buffer around this spatial value. The results are the
                  same.<pre class="pre codeblock"><code>SELECT name
FROM hospitals
WHERE
ST_Intersects(location,
  ST_Buffer(ST_Point(-74.237, 42.037), 46800.0))
ORDER BY name</code></pre>
                  Continuing
                  the previous examples, the distance from the specified point to each object within a 30 mile (or
                  approximately 46800m) radius can be found with this query, the results of which are shown
                  below.<pre class="pre codeblock"><code>SELECT name, ST_Distance(location, ST_Point(-74.237, 42.037)) AS distance
FROM hospitals
WHERE ST_Distance(location, ST_Point(-74.237, 42.037)) &lt; 46800.0
ORDER BY distance</code></pre>
                  <div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_t5y_llg_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e493">Name</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e495">distance (meters)</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Greene County Memorial Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">36634.88</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Adventist Home</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">39014.09</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Hudson River State Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">43362.54</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Saint Francis Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">43786.58</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Bowne Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">44319.48</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Columbia Memorial Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">44533.58</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Firemens Home</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">45066.09</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e493 ">Vassar Brothers Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e495 ">45525.13</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  Or, <samp class="ph codeph">ST_Buffer</samp> can be used to compute the spatial relation and then
                  determine the
                  distance.<pre class="pre codeblock"><code>SELECT name, ST_Distance(location, ST_Point(-74.237, 42.037)) AS distance
FROM hospitals
WHERE
  ST_Intersects(location,
  ST_Buffer(ST_Point(-74.237, 42.037), 46800.0))
ORDER BY distance</code></pre>
                  A
                  key difference to be noted here is that the <samp class="ph codeph">ST_Buffer</samp> in this package supports
                  buffering of arbitrary geometries and can be used to compute in that manner. Note that:
                  <ul class="ul">
                     <li class="li">The <samp class="ph codeph">ST_Buffer</samp> query on large geometries can be expensive.
                     </li>
                     
                     <li class="li">For a large number of geometries, the user is advised to calculate the buffers separately, store
                        the buffers in columns, and operate on the stored buffers.
                     </li>
                     
                  </ul>
                  
                  <pre class="pre codeblock"><code>SELECT name, ST_Distance(location, ST_WKTToSQL(
 'LINESTRING (-74.0 42.0, -73.0 42.0)'))
FROM hospitals
WHERE ST_Intersects(location, ST_Buffer(ST_WKTToSQL(
 'LINESTRING (-74.0 42.0, -73.0 42.0)'), 46800.0))</code></pre>
                  This
                  returns 31 results, the first 5 of which are:<div class="tablenoborder">
                     <table cellpadding="4" cellspacing="0" summary="" id="geo_common__table_yym_plg_vbb" class="table" rules="all" frame="border" border="1">
                        <thead class="thead" align="left">
                           <tr class="row">
                              <th class="entry thleft" valign="top" id="d18049e567">Name</th>
                              
                              <th class="entry thleft" valign="top" id="d18049e569">Distance</th>
                              
                           </tr>
                           
                        </thead>
                        
                        <tbody class="tbody">
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e567 ">Avery Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e569 ">38777.96</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e567 ">Hartford Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e569 ">38204.014</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e567 ">Springfield Municipal Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e569 ">39761.18</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e567 ">The Noble Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e569 ">23831.78</td>
                              
                           </tr>
                           
                           <tr class="row">
                              <td class="entry" valign="top" headers="d18049e567 ">Hudson River State Hospital</td>
                              
                              <td class="entry" valign="top" headers="d18049e569 ">29315.15</td>
                              
                           </tr>
                           
                        </tbody>
                        
                     </table>
                     
                  </div>
                  
               </div>
               
            </div>
            
         </div>
         
      </div>
   </body>
   
</html>